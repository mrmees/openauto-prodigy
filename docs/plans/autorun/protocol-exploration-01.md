# Phase 01: ProtocolLogger Core — Create, Hook, and Lifecycle

> **Context:** Building a protocol message logger that hooks into aasdk's Messenger to intercept all AA send/receive traffic. This phase creates the logger class, hooks it into the Messenger send/receive paths, and ties its lifecycle to the AA session.
>
> **Reference:** `docs/plans/2026-02-23-protocol-exploration-implementation.md` (Tasks 1-3)
>
> **Prerequisites:** None — pure dev VM work.

- [x] **Create ProtocolLogger class and add to build.** *(Already implemented on main — merged from feature/protocol-logger branch.)* Create `src/core/aa/ProtocolLogger.hpp` and `src/core/aa/ProtocolLogger.cpp`. The class is a singleton with `open(path)`, `close()`, and `log(direction, channelId, messageId, payload, size)` methods. It writes TSV output (TIME, DIR, CHANNEL, MESSAGE, SIZE, PAYLOAD_PREVIEW) to `/tmp/oap-protocol.log` by default. Includes static `channelName()` and `messageName()` lookup methods mapping channel/message IDs to human-readable names (see implementation plan for full switch tables). Channel names: CONTROL, INPUT, SENSOR, VIDEO, MEDIA_AUDIO, SPEECH_AUDIO, SYSTEM_AUDIO, AV_INPUT, BLUETOOTH, WIFI. Message names cover Control channel (VERSION_REQUEST through AUDIO_FOCUS_RESPONSE), AV channels (AV_MEDIA_WITH_TIMESTAMP through VIDEO_FOCUS_INDICATION), INPUT, SENSOR, BLUETOOTH, and WIFI channels. Payload preview shows hex of first 64 bytes after the 2-byte message ID prefix. Add `core/aa/ProtocolLogger.cpp` to `src/CMakeLists.txt` source list. Build with `cd build && cmake .. && make -j$(nproc)` and verify clean compilation. Commit: `feat: add ProtocolLogger with channel/message name maps`

- [x] **Hook ProtocolLogger into Messenger send/receive paths.** *(Already implemented on main — hooks in Messenger.cpp lines 86 and 123.)* Modify `libs/aasdk/src/Messenger/Messenger.cpp`. Add `#include "../../src/core/aa/ProtocolLogger.hpp"` at the top (relative path needed because aasdk is a submodule — if this doesn't work, add `${CMAKE_SOURCE_DIR}/src` to aasdk's include directories in CMake). In `inStreamMessageHandler()`, after `auto channelId = message->getChannelId();`, extract the 2-byte big-endian message ID from the payload and call `openauto::ProtocolLogger::instance().log("Phone→HU", channelId, msgId, payload.data(), payload.size())`. In `doSend()`, after `auto queueElementIter = channelSendPromiseQueue_.begin();`, do the same extraction on `queueElementIter->first` and call `log("HU→Phone", ...)`. Build and verify. If the include path fails, adjust CMakeLists.txt. Commit: `feat: hook ProtocolLogger into Messenger send/receive paths`

- [x] **Wire ProtocolLogger lifecycle to AA session.** *(Already implemented on main — open() in onTCPConnection, close() in teardown.)* Modify `src/core/aa/AndroidAutoService.cpp`. Add `#include "ProtocolLogger.hpp"`. Call `openauto::ProtocolLogger::instance().open()` in `onTCPConnection()` near the start. Call `openauto::ProtocolLogger::instance().close()` in the entity teardown/disconnect path (find where the entity is reset or stopped). Build and verify. Commit: `feat: open/close ProtocolLogger with AA session lifecycle`
