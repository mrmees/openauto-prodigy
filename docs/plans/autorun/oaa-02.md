# Phase 2: Transport Layer

**Context:** Building the transport layer for `libs/open-androidauto/`. Phase 1 (scaffolding) is complete — the library builds at `libs/open-androidauto/` with CMake, Qt6::Core, Qt6::Network, OpenSSL.

**Design doc:** `docs/plans/2026-02-23-open-androidauto-design.md` (see "Layer 1: Transport")

---

- [x] **Create ITransport interface.** Write `include/oaa/Transport/ITransport.hpp` — a QObject-derived abstract class in namespace `oaa` with pure virtual methods: `start()`, `stop()`, `write(const QByteArray&)`, `isConnected() const`. Signals: `dataReceived(const QByteArray&)`, `connected()`, `disconnected()`, `error(const QString&)`. No implementation file needed (pure interface). No test needed. Commit: `feat(oaa): add ITransport interface`

- [x] **Implement TCPTransport with tests.** Write `include/oaa/Transport/TCPTransport.hpp` and `src/Transport/TCPTransport.cpp`. TCPTransport inherits ITransport and wraps QTcpSocket. Public methods: `connectToHost(QHostAddress, quint16)` for outgoing connections, `setSocket(QTcpSocket*)` for pre-connected sockets (server-accepted). Implementation: `start()` connects QTcpSocket signals (readyRead→dataReceived via readAll(), disconnected, errorOccurred→error via errorString(), connected). `stop()` disconnects signals and closes socket. `write()` calls socket->write(). `isConnected()` checks socket state == ConnectedState. Add `src/Transport/TCPTransport.cpp` to library sources in CMakeLists.txt. Write `tests/test_tcp_transport.cpp` with QtTest: (1) `testConnectAndSend` — create QTcpServer on localhost, connect TCPTransport, verify connected signal, write "hello" and verify server receives it, server writes "world" and verify dataReceived signal. (2) `testDisconnect` — connect, then server closes, verify disconnected signal and isConnected()==false. Add test to tests/CMakeLists.txt. Build and run all tests. Commit: `feat(oaa): implement TCPTransport with QTcpSocket`
    - **Note:** Required `ITransport.cpp` with out-of-line destructor for vtable emission, and headers listed in CMake `add_library()` sources for AUTOMOC discovery. Both are common Qt gotchas.

- [x] **Implement ReplayTransport (test double) with tests.** Write `include/oaa/Transport/ReplayTransport.hpp` and `src/Transport/ReplayTransport.cpp`. ReplayTransport inherits ITransport — no real socket. Test API: `feedData(QByteArray)` emits dataReceived, `simulateConnect()` sets connected_=true and emits connected(), `simulateDisconnect()` sets connected_=false and emits disconnected(), `writtenData()` returns QList<QByteArray> of everything passed to write(), `clearWritten()` resets. `start()`/`stop()` are no-ops (just toggle a started_ flag). `isConnected()` returns connected_ state. Write `tests/test_replay_transport.cpp`: (1) `testFeedData` — start, feedData, verify dataReceived signal with correct payload. (2) `testWriteCapture` — start, write data, verify writtenData() contains it. (3) `testSimulateConnect` — verify connected signal and isConnected(). Add to CMakeLists. Build and run all tests. Commit: `feat(oaa): add ReplayTransport for testing`
